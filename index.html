<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Bus Status</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #4b0082, #8a2be2);
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            width: 100%;
        }
        .card {
            background-color: #ffffff;
            color: #333333;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 24px;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
        }
        .input-group {
            position: relative;
        }
        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            border-color: #00b5f1;
            box-shadow: 0 0 0 3px rgba(0, 181, 241, 0.2);
        }
        .btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #1c529a;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #1a4a8c;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-llm {
            background-color: #ff9800;
        }
        .btn-llm:hover {
            background-color: #e68a00;
        }
        .or-divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 24px 0;
            color: #ffffff;
            font-size: 14px;
        }
        .or-divider::before, .or-divider::after {
            content: '';
            flex-grow: 1;
            height: 1px;
            background: #ffffff;
            opacity: 0.5;
        }
        .or-divider::before {
            margin-right: 12px;
        }
        .or-divider::after {
            margin-left: 12px;
        }
        .swap-icon-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #e5e7eb;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .swap-icon-btn:hover {
            background-color: #d1d5db;
            transform: translateY(-50%) rotate(180deg);
        }
        .swap-icon {
            transform: rotate(90deg);
        }
        .result-message {
            margin-top: 24px;
            padding: 16px;
            background-color: #f3f4f6;
            border-radius: 8px;
            font-size: 16px;
            line-height: 1.5;
            display: none;
        }
        .date-container {
            position: relative;
            cursor: pointer;
            z-index: 10;
        }
        .date-display {
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #ffffff;
            color: #333333;
        }
        .calendar-popup {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 24px;
            margin-top: 8px;
            z-index: 20;
            width: 320px;
            display: none;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            text-align: center;
        }
        .day-name {
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
        }
        .date-cell {
            padding: 8px;
            cursor: pointer;
            border-radius: 9999px;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .date-cell:hover:not(.inactive) {
            background-color: #e5e7eb;
        }
        .date-cell.selected {
            background-color: #1c529a;
            color: #ffffff;
            font-weight: 600;
        }
        .date-cell.inactive {
            color: #9ca3af;
            cursor: default;
        }
        .nav-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .nav-btn:hover {
            background-color: #e5e7eb;
        }
        .ai-circle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-image: linear-gradient(45deg, #ff9800, #ff5722);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25), 0 0 20px rgba(255, 152, 0, 0.5);
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 50;
            animation: pulse 2s infinite;
        }
        .ai-circle:hover {
            transform: scale(1.1);
        }
        .ai-chat-box {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 350px;
            height: 450px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            z-index: 100;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
        }
        .ai-chat-box.visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        .ai-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: #1c529a;
            color: #fff;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .ai-chat-header h3 {
            font-weight: 600;
        }
        .ai-chat-close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
        }
        .ai-chat-language-btn {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .ai-chat-messages {
            flex-grow: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 10px;
        }
        .message.user {
            align-self: flex-end;
            background-color: #ff9800;
            color: #fff;
        }
        .message.ai {
            align-self: flex-start;
            background-color: #f3f4f6;
            color: #333;
            white-space: pre-wrap;
        }
        .ai-chat-input-area {
            display: flex;
            padding: 12px;
            border-top: 1px solid #e5e7eb;
            background-color: #f9f9f9;
        }
        .ai-chat-input-area input {
            flex-grow: 1;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 12px;
            outline: none;
            transition: border-color 0.2s;
            background-color: #fff;
            color: #333;
        }
        .ai-chat-input-area input:focus {
            border-color: #00b5f1;
        }
        .ai-chat-input-area button {
            background-color: #1c529a;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            margin-left: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .loading-dots {
            display: none;
            align-items: center;
            justify-content: center;
            height: 20px;
        }
        .loading-dots.active {
            display: flex;
        }
        .loading-dot {
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            margin: 0 4px;
            animation: bounce 0.6s infinite alternate;
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            to {
                transform: translateY(-8px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-4" data-translate="main_title">Live Bus Status</h1>
        <p class="text-center text-lg mb-10 text-gray-200" data-translate="main_subtitle">Find bus routes, check PNR status, and get travel tips instantly.</p>

        <div class="flex flex-col lg:flex-row lg:space-x-8">
            <!-- Search by Bus Number & PNR Status Card -->
            <div class="card lg:w-1/2">
                <h2 class="text-xl font-semibold mb-4 text-center" data-translate="bus_number_title">Search by Bus Number</h2>
                <div class="input-group mb-4">
                    <input id="busNumberInput" type="text" placeholder="Enter Bus Number" class="input-field" data-translate-placeholder="bus_number_placeholder">
                </div>
                <button id="searchByBusBtn" class="btn btn-primary" data-translate="check_status_btn">Check Status</button>

                <div class="or-divider" data-translate="or_divider">or</div>

                <h2 class="text-xl font-semibold mb-4 text-center" data-translate="pnr_title">PNR Status</h2>
                <div class="input-group mb-4">
                    <input id="pnrInput" type="text" placeholder="Enter PNR Number" class="input-field" data-translate-placeholder="pnr_placeholder">
                </div>
                <button id="checkPnrBtn" class="btn btn-primary" data-translate="check_pnr_btn">Check PNR Status</button>
            </div>

            <!-- Search by Route Card -->
            <div class="card lg:w-1/2">
                <h2 class="text-xl font-semibold mb-4 text-center" data-translate="route_title">Search by Route</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <input id="fromStationInput" type="text" placeholder="From Stop" class="input-field" data-translate-placeholder="from_stop_placeholder">
                    </div>
                    <div class="input-group relative">
                        <input id="toStationInput" type="text" placeholder="To Stop" class="input-field" data-translate-placeholder="to_stop_placeholder">
                        <span id="swapStopsBtn" class="swap-icon-btn">
                            <svg class="swap-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="17 1 17 8 23 8"></polyline>
                                <path d="M20 5H10a4 4 0 0 0-4 4v2"></path>
                                <polyline points="7 23 7 16 1 16"></polyline>
                                <path d="M4 19h10a4 4 0 0 0 4-4v-2"></path>
                            </svg>
                        </span>
                    </div>
                </div>
                
                <!-- Calendar Date Selector -->
                <div class="date-container mb-4">
                    <label class="block text-gray-700 font-medium mb-2" data-translate="departure_date">Departure Date</label>
                    <div id="dateDisplay" class="date-display">
                        <span data-translate="select_date">Select Date</span>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    <div id="calendarPopup" class="calendar-popup">
                        <div class="calendar-header">
                            <button id="prevMonthBtn" class="nav-btn">
                                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <span id="monthYearText" class="text-lg font-semibold"></span>
                            <button id="nextMonthBtn" class="nav-btn">
                                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                        <div id="calendarGrid" class="calendar-grid">
                            <span class="day-name" data-translate="day_sun">Sun</span>
                            <span class="day-name" data-translate="day_mon">Mon</span>
                            <span class="day-name" data-translate="day_tue">Tue</span>
                            <span class="day-name" data-translate="day_wed">Wed</span>
                            <span class="day-name" data-translate="day_thu">Thu</span>
                            <span class="day-name" data-translate="day_fri">Fri</span>
                            <span class="day-name" data-translate="day_sat">Sat</span>
                        </div>
                    </div>
                    <input id="dateInput" type="hidden">
                </div>

                <button id="searchByRouteBtn" class="btn btn-primary mb-2" data-translate="check_buses_btn">Check Buses</button>
                <button id="getTravelTipsBtn" class="btn btn-primary btn-llm" data-translate="travel_tips_btn">Get Travel Tips ✨</button>
            </div>
        </div>

        <!-- Result Card -->
        <div id="resultCard" class="result-message text-center">
            <p id="resultText"></p>
        </div>
    </div>

    <!-- AI Circle Button -->
    <div class="ai-circle" id="aiCircleBtn">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M5 11V7m0 4h4m0 0v4m0 0h4m0 0V7m0 4h4m0 0v-4m0 4h-4m-4 4v4m0 0h4m0 0v-4m-4 4h4m0 0V7m0 4h4m0 0v4m0 0h4m-4-4h-4m-4 4h4M9 3v4m0 0h4m0 0V3m0 4h-4m4-4H9m0 4h4m0-4V3m0 4h-4M9 11v-4m0 4h4m0 0V7m0 4h4m0 0v-4m0 4h-4M9 15v-4m0 4h4m0 0V11m0 4h4m0-4h-4m4 4h4m0-4v-4m0 4h-4m4 0v-4m0 4h-4M19 3v4m0 0h-4M19 11v-4m0 4h-4m0 0v4M19 11h4m-4 4h4m0-4v4m0-4h-4M19 15v4m0-4h4m0 4h-4m0 0v-4m0 4h-4m0 0v-4M15 15v4m0 0h4m0 0v-4m0 4h-4m0 0V11m0 4h4m0 0v4m0 0h-4m0 0v-4m0 4h4M9 11v4M9 11h4M9 15h4M9 15v4M9 15h4M9 11h4"></path>
        </svg>
    </div>

    <!-- AI Chat Box -->
    <div class="ai-chat-box" id="aiChatBox">
        <div class="ai-chat-header">
            <h3 data-translate="ai_chat_title">AI Assistant</h3>
            <div class="flex items-center space-x-2">
                <button id="languageBtn" class="ai-chat-language-btn">EN</button>
                <button id="closeChatBtn" class="ai-chat-close-btn">&times;</button>
            </div>
        </div>
        <div class="ai-chat-messages" id="chatMessages">
            <div class="message ai" data-translate="ai_initial_message">
                Hello! I am your AI bus assistant. Ask me anything about bus travel!
            </div>
        </div>
        <div class="ai-chat-input-area">
            <input type="text" id="chatInput" placeholder="Type a message..." data-translate-placeholder="chat_placeholder">
            <button id="chatSendBtn" data-translate="chat_send_btn">Send</button>
        </div>
    </div>

    <script>
        // Use an IIFE to encapsulate the script
        (function() {
            const busNumberInput = document.getElementById('busNumberInput');
            const searchByBusBtn = document.getElementById('searchByBusBtn');
            const fromStationInput = document.getElementById('fromStationInput');
            const toStationInput = document.getElementById('toStationInput');
            const swapStopsBtn = document.getElementById('swapStopsBtn');
            const dateInput = document.getElementById('dateInput');
            const dateDisplay = document.getElementById('dateDisplay');
            const calendarPopup = document.getElementById('calendarPopup');
            const monthYearText = document.getElementById('monthYearText');
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            const nextMonthBtn = document.getElementById('nextMonthBtn');
            const calendarGrid = document.getElementById('calendarGrid');
            const searchByRouteBtn = document.getElementById('searchByRouteBtn');
            const getTravelTipsBtn = document.getElementById('getTravelTipsBtn');
            const pnrInput = document.getElementById('pnrInput');
            const checkPnrBtn = document.getElementById('checkPnrBtn');
            const resultCard = document.getElementById('resultCard');
            const resultText = document.getElementById('resultText');

            const aiCircleBtn = document.getElementById('aiCircleBtn');
            const aiChatBox = document.getElementById('aiChatBox');
            const closeChatBtn = document.getElementById('closeChatBtn');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const languageBtn = document.getElementById('languageBtn');

            // --- Internationalization (i18n) Logic ---
            const translations = {
                'en': {
                    main_title: "Live Bus Status",
                    main_subtitle: "Find bus routes, check PNR status, and get travel tips instantly.",
                    bus_number_title: "Search by Bus Number",
                    bus_number_placeholder: "Enter Bus Number",
                    check_status_btn: "Check Status",
                    or_divider: "or",
                    pnr_title: "PNR Status",
                    pnr_placeholder: "Enter PNR Number",
                    check_pnr_btn: "Check PNR Status",
                    route_title: "Search by Route",
                    from_stop_placeholder: "From Stop",
                    to_stop_placeholder: "To Stop",
                    departure_date: "Departure Date",
                    select_date: "Select Date",
                    check_buses_btn: "Check Buses",
                    travel_tips_btn: "Get Travel Tips ✨",
                    day_sun: "Sun", day_mon: "Mon", day_tue: "Tue", day_wed: "Wed", day_thu: "Thu", day_fri: "Fri", day_sat: "Sat",
                    ai_chat_title: "AI Assistant",
                    chat_placeholder: "Type a message...",
                    chat_send_btn: "Send",
                    ai_initial_message: "Hello! I am your AI bus assistant. Ask me anything about bus travel!",
                    loading_message: "Generating response..."
                },
                'hi': {
                    main_title: "लाइव बस स्थिति",
                    main_subtitle: "बस रूट ढूंढें, पीएनआर स्थिति की जांच करें, और तुरंत यात्रा युक्तियाँ प्राप्त करें।",
                    bus_number_title: "बस नंबर द्वारा खोजें",
                    bus_number_placeholder: "बस नंबर दर्ज करें",
                    check_status_btn: "स्थिति जांचें",
                    or_divider: "या",
                    pnr_title: "पीएनआर स्थिति",
                    pnr_placeholder: "पीएनआर नंबर दर्ज करें",
                    check_pnr_btn: "पीएनआर स्थिति जांचें",
                    route_title: "मार्ग द्वारा खोजें",
                    from_stop_placeholder: "से स्टॉप",
                    to_stop_placeholder: "तक स्टॉप",
                    departure_date: "प्रस्थान की तारीख",
                    select_date: "दिनांक चुनें",
                    check_buses_btn: "बसें जांचें",
                    travel_tips_btn: "यात्रा युक्तियाँ प्राप्त करें ✨",
                    day_sun: "रवि", day_mon: "सोम", day_tue: "मंगल", day_wed: "बुध", day_thu: "गुरु", day_fri: "शुक्र", day_sat: "शनि",
                    ai_chat_title: "एआई सहायक",
                    chat_placeholder: "एक संदेश टाइप करें...",
                    chat_send_btn: "भेजें",
                    ai_initial_message: "नमस्ते! मैं आपका एआई बस सहायक हूं। बस यात्रा के बारे में मुझसे कुछ भी पूछें!",
                    loading_message: "प्रतिक्रिया उत्पन्न हो रही है..."
                },
                'pa': {
                    main_title: "ਲਾਈਵ ਬੱਸ ਸਥਿਤੀ",
                    main_subtitle: "ਬੱਸ ਰੂਟ ਲੱਭੋ, ਪੀਐਨਆਰ ਸਥਿਤੀ ਦੀ ਜਾਂਚ ਕਰੋ, ਅਤੇ ਤੁਰੰਤ ਯਾਤਰਾ ਦੀਆਂ ਸਲਾਹਾਂ ਪ੍ਰਾਪਤ ਕਰੋ।",
                    bus_number_title: "ਬੱਸ ਨੰਬਰ ਦੁਆਰਾ ਖੋਜ ਕਰੋ",
                    bus_number_placeholder: "ਬੱਸ ਨੰਬਰ ਦਰਜ ਕਰੋ",
                    check_status_btn: "ਸਥਿਤੀ ਜਾਂਚੋ",
                    or_divider: "ਜਾਂ",
                    pnr_title: "ਪੀਐਨਆਰ ਸਥਿਤੀ",
                    pnr_placeholder: "ਪੀਐਨਆਰ ਨੰਬਰ ਦਰਜ ਕਰੋ",
                    check_pnr_btn: "ਪੀਐਨਆਰ ਸਥਿਤੀ ਜਾਂਚੋ",
                    route_title: "ਮਾਰਗ ਦੁਆਰਾ ਖੋਜ ਕਰੋ",
                    from_stop_placeholder: "ਤੋਂ ਸਟਾਪ",
                    to_stop_placeholder: "ਤੱਕ ਸਟਾਪ",
                    departure_date: "ਜਾਣ ਦੀ ਤਾਰੀਖ",
                    select_date: "ਤਾਰੀਖ ਚੁਣੋ",
                    check_buses_btn: "ਬੱਸਾਂ ਦੀ ਜਾਂਚ ਕਰੋ",
                    travel_tips_btn: "ਯਾਤਰਾ ਦੀਆਂ ਸਲਾਹਾਂ ਪ੍ਰਾਪਤ ਕਰੋ ✨",
                    day_sun: "ਐਤ", day_mon: "ਸੋਮ", day_tue: "ਮੰਗਲ", day_wed: "ਬੁੱਧ", day_thu: "ਵੀਰ", day_fri: "ਸ਼ੁੱਕਰ", day_sat: "ਸ਼ਨੀ",
                    ai_chat_title: "ਏਆਈ ਸਹਾਇਕ",
                    chat_placeholder: "ਇੱਕ ਸੁਨੇਹਾ ਟਾਈਪ ਕਰੋ...",
                    chat_send_btn: "ਭੇਜੋ",
                    ai_initial_message: "ਨਮਸਤੇ! ਮੈਂ ਤੁਹਾਡਾ ਏਆਈ ਬੱਸ ਸਹਾਇਕ ਹਾਂ। ਬੱਸ ਯਾਤਰਾ ਬਾਰੇ ਕੁਝ ਵੀ ਪੁੱਛੋ!",
                    loading_message: "ਪ੍ਰਤੀਕਿਰਿਆ ਤਿਆਰ ਹੋ ਰਹੀ ਹੈ..."
                }
            };
            let currentLang = 'en';
            const langCodes = ['en', 'hi', 'pa'];
            let langIndex = 0;

            const updateLanguage = (lang) => {
                document.querySelectorAll('[data-translate]').forEach(el => {
                    const key = el.getAttribute('data-translate');
                    if (translations[lang] && translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });
                document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-translate-placeholder');
                    if (translations[lang] && translations[lang][key]) {
                        el.placeholder = translations[lang][key];
                    }
                });
                languageBtn.textContent = lang.toUpperCase();
                // Update calendar day names
                const dayNameElements = document.querySelectorAll('.day-name');
                if (dayNameElements.length > 0) {
                    dayNameElements[0].textContent = translations[lang].day_sun;
                    dayNameElements[1].textContent = translations[lang].day_mon;
                    dayNameElements[2].textContent = translations[lang].day_tue;
                    dayNameElements[3].textContent = translations[lang].day_wed;
                    dayNameElements[4].textContent = translations[lang].day_thu;
                    dayNameElements[5].textContent = translations[lang].day_fri;
                    dayNameElements[6].textContent = translations[lang].day_sat;
                }
            };

            languageBtn.addEventListener('click', () => {
                langIndex = (langIndex + 1) % langCodes.length;
                currentLang = langCodes[langIndex];
                updateLanguage(currentLang);
                // Rerender calendar to update day names
                renderCalendar(currentDate);
            });

            // --- Calendar Logic ---
            let currentDate = new Date();
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            const renderCalendar = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                monthYearText.textContent = `${monthNames[month]} ${year}`;
                
                // Clear previous dates
                const existingDates = calendarGrid.querySelectorAll('.date-cell');
                existingDates.forEach(cell => cell.remove());

                // Add empty cells for padding
                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'date-cell inactive';
                    calendarGrid.appendChild(emptyCell);
                }

                // Add date cells
                for (let i = 1; i <= daysInMonth; i++) {
                    const dateCell = document.createElement('div');
                    dateCell.className = 'date-cell';
                    dateCell.textContent = i;
                    dateCell.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    calendarGrid.appendChild(dateCell);
                }

                // Highlight the selected date
                const selectedDate = dateInput.value;
                if (selectedDate) {
                    const cell = calendarGrid.querySelector(`[data-date="${selectedDate}"]`);
                    if (cell) {
                        cell.classList.add('selected');
                    }
                }
            };
            
            // Function to handle date selection
            const selectDate = (date) => {
                const formattedDate = date.toISOString().split('T')[0];
                const day = dayNames[date.getDay()];
                const month = monthNames[date.getMonth()];
                dateDisplay.innerHTML = `<span>${date.getDate()} ${month}, ${day}</span><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`;
                dateInput.value = formattedDate;
                calendarPopup.style.display = 'none';
            };

            // Event listeners for calendar navigation
            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar(currentDate);
            });

            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar(currentDate);
            });

            calendarGrid.addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('date-cell') && !target.classList.contains('inactive')) {
                    const selectedDate = new Date(target.dataset.date);
                    selectDate(selectedDate);
                }
            });

            dateDisplay.addEventListener('click', () => {
                renderCalendar(currentDate);
                calendarPopup.style.display = 'block';
            });
            
            // Close calendar when clicking outside
            window.addEventListener('click', (event) => {
                if (!event.target.closest('.date-container') && !event.target.closest('.ai-chat-box') && calendarPopup.style.display === 'block') {
                    calendarPopup.style.display = 'none';
                }
            });

            // Set initial selected date to today
            selectDate(new Date());

            // --- Sample Data and Logic ---
            const busData = {
                '101': {
                    route: 'Downtown to City Center',
                    status: 'Approaching next stop (5 min away)',
                    stops: ['Downtown', 'Oak Street', 'Main Square', 'City Center']
                },
                '205': {
                    route: 'Suburb to University',
                    status: 'Departed from previous stop (10 min away)',
                    stops: ['Suburb', 'Green Park', 'University']
                },
                '303': {
                    route: 'Airport to City',
                    status: 'On time',
                    stops: ['Airport', 'Highway', 'Bus Terminal']
                }
            };
            
            const pnrData = {
                'PNR12345': {
                    busNumber: '101',
                    passengerName: 'John Doe',
                    status: 'Confirmed',
                    seatNumber: '12A'
                },
                'PNR67890': {
                    busNumber: '205',
                    passengerName: 'Jane Smith',
                    status: 'Waitlisted (WL 2)',
                    seatNumber: 'N/A'
                },
            };

            function showResult(message) {
                resultText.textContent = message;
                resultCard.style.display = 'block';
            }

            function clearResult() {
                resultCard.style.display = 'none';
                resultText.textContent = '';
            }

            // Search by Bus Number
            searchByBusBtn.addEventListener('click', () => {
                clearResult();
                const busNumber = busNumberInput.value.trim().toUpperCase();
                if (!busNumber) {
                    showResult('Please enter a bus number.');
                    return;
                }
                
                const bus = busData[busNumber];
                if (bus) {
                    showResult(`Bus ${busNumber} is currently: ${bus.status}. Route: ${bus.route}.`);
                } else {
                    showResult(`No live status found for bus number ${busNumber}.`);
                }
            });

            // Swap From and To stops
            swapStopsBtn.addEventListener('click', () => {
                const fromValue = fromStationInput.value;
                const toValue = toStationInput.value;
                fromStationInput.value = toValue;
                toStationInput.value = fromValue;
            });

            // Search by Route
            searchByRouteBtn.addEventListener('click', () => {
                clearResult();
                const fromStop = fromStationInput.value.trim().toLowerCase();
                const toStop = toStationInput.value.trim().toLowerCase();
                const selectedDate = dateInput.value;

                if (!fromStop || !toStop) {
                    showResult('Please enter both "From Stop" and "To Stop" locations.');
                    return;
                }
                
                let foundBuses = [];
                for (const busNumber in busData) {
                    const bus = busData[busNumber];
                    const stops = bus.stops.map(stop => stop.toLowerCase());
                    const fromIndex = stops.indexOf(fromStop);
                    const toIndex = stops.indexOf(toStop);
                    
                    if (fromIndex !== -1 && toIndex !== -1 && fromIndex < toIndex) {
                        foundBuses.push(busNumber);
                    }
                }

                if (foundBuses.length > 0) {
                    const busList = foundBuses.join(', ');
                    showResult(`Buses found on ${selectedDate} for this route: ${busList}.`);
                } else {
                    showResult(`No direct buses found from "${fromStop}" to "${toStop}" on ${selectedDate}.`);
                }
            });

            // Check PNR Status
            checkPnrBtn.addEventListener('click', () => {
                clearResult();
                const pnrNumber = pnrInput.value.trim().toUpperCase();
                if (!pnrNumber) {
                    showResult('Please enter a PNR number.');
                    return;
                }

                const status = pnrData[pnrNumber];
                if (status) {
                    showResult(`PNR Status for ${pnrNumber}: Bus No. ${status.busNumber}, Status: ${status.status}, Seat: ${status.seatNumber}.`);
                } else {
                    showResult(`No record found for PNR number ${pnrNumber}. Please check your PNR and try again.`);
                }
            });

            // --- Gemini API Integration for Travel Tips ---
            getTravelTipsBtn.addEventListener('click', async () => {
                clearResult();
                const fromStop = fromStationInput.value.trim();
                const toStop = toStationInput.value.trim();

                if (!fromStop || !toStop) {
                    showResult('Please enter both a "From Stop" and "To Stop" to get travel tips.');
                    return;
                }

                showResult('Generating travel tips... please wait.');

                try {
                    const payload = {
                        contents: [{
                            parts: [{
                                text: `Generate a short paragraph of travel tips for a bus journey from ${fromStop} to ${toStop}. Mention something about bus travel best practices and things to do at the destination. Keep it concise.`
                            }]
                        }],
                        // Use Gemini Flash model for quick generation
                        model: "gemini-2.5-flash-preview-05-20"
                    };

                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${payload.model}:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error('API request failed');
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        showResult(`✨ Travel Tips for your journey from ${fromStop} to ${toStop}: ${text}`);
                    } else {
                        showResult('Failed to get travel tips. Please try again.');
                    }
                } catch (error) {
                    console.error('Error fetching data from Gemini API:', error);
                    showResult('An error occurred while generating tips. Please try again later.');
                }
            });

            // --- AI Chatbox Logic ---
            aiCircleBtn.addEventListener('click', () => {
                aiChatBox.classList.toggle('visible');
            });

            closeChatBtn.addEventListener('click', () => {
                aiChatBox.classList.remove('visible');
            });

            chatSendBtn.addEventListener('click', async () => {
                const userMessage = chatInput.value.trim();
                if (userMessage === '') return;

                appendMessage(userMessage, 'user');
                chatInput.value = '';
                showLoading();

                try {
                    const payload = {
                        contents: [{
                            parts: [{
                                text: `Your response should be formatted in markdown for easy readability. Use headings, bold text, and bullet points. You are a helpful bus travel assistant for India. The user's query is: "${userMessage}". Please respond in ${currentLang}.`
                            }]
                        }],
                        model: "gemini-2.5-flash-preview-05-20"
                    };

                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${payload.model}:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error('API request failed');
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    hideLoading();
                    if (text) {
                        appendMessage(text, 'ai');
                    } else {
                        appendMessage("Sorry, I couldn't get a response. Please try again.", 'ai');
                    }
                } catch (error) {
                    hideLoading();
                    console.error('Error fetching data from Gemini API:', error);
                    appendMessage("An error occurred while generating a response. Please try again later.", 'ai');
                }
            });

            function appendMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', sender);
                if (sender === 'ai') {
                    // This is where we format the AI response with markdown
                    const converter = new showdown.Converter();
                    messageDiv.innerHTML = converter.makeHtml(text);
                } else {
                    messageDiv.textContent = text;
                }
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll
            }

            function showLoading() {
                const loadingDiv = document.createElement('div');
                loadingDiv.classList.add('message', 'ai', 'loading-dots', 'active');
                loadingDiv.innerHTML = '<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function hideLoading() {
                const loadingDiv = chatMessages.querySelector('.loading-dots');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }
            
            // Initial language update
            updateLanguage(currentLang);
            
        })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
</body>
</html>